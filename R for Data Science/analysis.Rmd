---
title: Gapminder analysis
author: Ben Yang
output: html_document
---

# Guided section

```{r results='hide', message=F}
library(tidyverse)
library(plotly)
```

## 1. Read data

```{r results='hide', message=F, warning=F}
data <- read_csv('./gapminder_clean.csv') %>%
    select(-1) %>%
    rename(
       co2em = `CO2 emissions (metric tons per capita)`,
       popden = `Population density (people per sq. km of land area)`,
       lifeExp = `Life expectancy at birth, total (years)`,
       energy = `Energy use (kg of oil equivalent per capita)`,
    )
```

## 2. Scatter plot of CO2 emissions and GDP in 1962

```{r}
data1962 <- data %>%
    filter(Year == 1962) %>%
    select(gdpPercap, co2em) %>%
    drop_na()
ggplot(data = data1962) +
    geom_point(mapping = aes(
        x = gdpPercap,
        y = co2em)) +
    labs(x = "GDP per capita", y = "CO2 emissions per capita (metric tons)")
```

## 3. Pearson correlation of CO2 emissions and GDP

```{r}
cor.test(data1962 %>% pull(gdpPercap), data1962 %>% pull(co2em))
```

## 4. Year of strongest correlation between CO2 emissions and GDP

```{r results='hide', message=F}
corrs <- data %>%
    group_by(Year) %>%
    select(Year, gdpPercap, co2em) %>%
    drop_na() %>%
    summarise(correlation = cor(gdpPercap, co2em))
maxi <- lapply(corrs, max)
```

The strongest correlation is `r maxi$correlation` in the year `r maxi$Year`.

## 5. Interactive scatter plot of CO2 emissions and GDP

```{r, warning=F}
max_em_year_data <- data %>%
    filter(Year == maxi$Year) %>%
    select(gdpPercap, co2em, pop, continent, `Country Name`) %>%
    drop_na()
fig <- ggplot(data = max_em_year_data) +
    geom_point(aes(
        x = gdpPercap,
        y = co2em,
        size = pop,
        color = continent,
        text = paste("Country: ", `Country Name`,
             "\nGDP: ", gdpPercap,
             "\nCO2 emissions: ", co2em))) +
    xlab("GDP per capita") +
    ylab("CO2 emissions per capita (metric tons)") +
    ggtitle(str_glue("GDP vs CO2 emissions per capita in ", maxi$Year))
ggplotly(fig, tooltip = "text")
```

# Open section

## 1. Relationship between continent and energy use

### General visual

Let's get a general idea of what we're looking at.

```{r}
data_energy <- data %>%
    select(continent, energy) %>%
    drop_na()
ggplot(data_energy, mapping = aes(energy, color = continent)) +
    geom_freqpoly(binwidth = 500)
```

It looks like we've got peaks at the same location for Africa, the Americas and
Asia. Europe and Oceania are doing their own thing.

The next question is _can we perform ANOVA_ and statistically determine
relationships in the data. First, we'll check the assumptions.

### Normality

Let's observe how normal the data is.

```{r}
ggplot(data_energy, mapping = aes(sample = energy)) +
    facet_grid(continent ~ .) +
    stat_qq() +
    stat_qq_line()
```

Africa, Oceania and Europe look approximately normal, but the others do not.
Let's apply a data transformation. We get an empty tibble when filtering for
energy values less than or equal to zero. So, it is safe to apply the logarithm
to the energy usage data.

```{r}
data_energy %>%
    filter(energy <= 0)
```

Let's try the data transformation.

```{r}
data_energy_t <- data_energy %>%
    mutate(energy_transformed = log(energy))
ggplot(data_energy_t, mapping = aes(sample = energy_transformed)) +
    facet_grid(continent ~ .) +
    stat_qq() +
    stat_qq_line()
```

The data look more normal now. Oceania remains normal. The other groups' data
are still not perfect, but it's okay since we have a relatively large sample
size for them.

```{r}
data_energy_t %>%
    group_by(continent) %>%
    summarise(count = n())
```

### Independence

The data come from different continents and are at least 5 years apart. Assume
the data are independent due to this space and time separation.

### Equality of variances

How do the variances look?

```{r}
ggplot(data_energy_t) +
    geom_boxplot(mapping = aes(energy_transformed, continent)) +
    xlab("Log of energy usage (kg of oil equivalent per capita)") +
    ylab("Continent")
```

The variances of the transformed data look roughly the same. Oceania stands out
as having a smaller variance than the others. Asia looks like it has a larger
variance. Despite this, we will continue.

### ANOVA

```{r}
test_results <- aov(energy_transformed ~ continent, data = data_energy_t)
summary.aov(test_results)
```

The p-value is less than 0.001. In our assumptions, we saw that the transformed
data were not exactly normal, and their variances were not exactly equal.
Taking that into account, I still think we can reject the null hypothesis. That
is, we can reject that the log of the group means are equal. Since the
logarithm is a monotone increasing function, we can reject that the group means
are equal.

### Post hoc testing via Tukey's

```{r}
TukeyHSD(test_results)
```

For every pair except for (Asia, Americas) and (Oceania, Europe), we reject the
null hypothesis that the logarithm of the energy usage means are the same.

## 2. Difference of imports between Europe and Asia

## 3. Country with the highest average population density in 1962-2007

```{r}
data_popden <- data %>%
    group_by(`Country Name`) %>%
    select(`Country Name`, popden) %>%
    summarise(avg_popden = mean(popden, na.rm = TRUE)) %>%
    arrange(desc(avg_popden))
num_countries_shown <- 20
ggplot(data = head(data_popden, n = num_countries_shown)) +
    geom_bar(
        mapping = aes(x = avg_popden, y = reorder(`Country Name`, avg_popden)),
        stat = "identity") +
    xlab("Average population density (people per sq. km of land)") +
    ylab("") +
    ggtitle(str_glue(num_countries_shown, " most population dense countries 1962-2007"))
```

The country with the highest average population density between 1962 and 2007
is __Macao SAR, China__.

## 4. Country with the greatest increase in life expectancy at birth since 1962

```{r}
data_lifeExp <- data %>%
    select(`Country Name`, Year, lifeExp) %>%
    drop_na() %>%
    group_by(`Country Name`) %>%
    filter(any(Year == 1962)) %>%
    mutate(lifeExpSince1962 = lifeExp - lifeExp[Year == 1962]) %>%
    ungroup()

countries_highest <- data_lifeExp %>%
    group_by(`Country Name`) %>%
    mutate(lifeExpTotalChange = lifeExp[Year == 2007] - lifeExp[Year == 1962]) %>%
    summarise(lifeExpChange = max(lifeExpTotalChange)) %>%
    arrange(desc(lifeExpChange))

cutoff_lifeExpChange <- min(head(countries_highest, n = 10)$lifeExpChange)

data_lifeExpTop <- data_lifeExp %>%
    group_by(`Country Name`) %>%
    filter(lifeExp[Year == 2007] - lifeExp[Year == 1962] >= cutoff_lifeExpChange)

fig <- ggplot(data = data_lifeExpTop) + 
    geom_line(mapping = aes(
        x = Year,
        y = lifeExpSince1962,
        color = `Country Name`)
    ) +
    ylab("Life expectancy at birth since 1962 (years)")
ggplotly(fig)
```

The __Maldives__ had the highest increase in life expectancy at birth from 1962 to 2007.
